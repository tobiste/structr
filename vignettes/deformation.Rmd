---
title: "Deformation and Velocity Gradient Tensor"
author: "Tobias Stephan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
description: >
 Deforming orientation data over time
vignette: >
  %\VignetteIndexEntry{Deformation and Velocity Gradient Tensor}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  markdown: 
    wrap: 72
---

This tutorial demonstrates how {structr} can be used to deform
orientation data using deformation and velocity gradient tensors. This
can be useful to simulate progressive deformation and change of
orientation.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(20250411)
```

```{r setup, warning=FALSE, message=FALSE}
library(structr)
```

## Deformation gradient tensor

3D deformation gradient tensor is a matrix that linearly transforms
points. In other words it describes the changes of points in three
dimensions.

### Define a deformation gradient tensor

The deformation matrix can be defined using several ways:

-   `defgrad_by_comp()` creates an defined by individual components
    (default is identity tensor)
-   `defgrad_by_ratio()` creates an isochoric tensor with
    axial stretches defined by strain ratios (default is identity
    tensor).
-   `defgrad_from_vectors()` creates  tensor representing
    rotation around the axis perpendicular to both vectors and rotate
    `v1` to `v2`.
-   `defgrad_from_axisangle()` creates tensor representing a rigid-body
    rotation about an axis and an angle.
-   `defgrad_from_pureshear()` creates an isochoric coaxial tensor.
-   `defgrad_from_simpleshear()` creates an isochoric non-coaxial tensor.
-   `defgrad_from_generalshear()` creates an isochoric tensor,
    where *transtension* is $k>1$ and $\gamma \neq 0$, and
    *transpression* is $k<1$ and $\gamma \neq 0$ ([^1])
-   `defgrad_from_dilation()` creates tensor representing the
    volume change in z-direction.

[^1]: Fossen, H., & Tikoff, B. (1993). The deformation matrix for simultaneous simple shearing, pure shearing and volume change, and its application to transpression-transtension tectonics. Journal of Structural Geology, 15(3–5), 413–422. https://doi.org/10.1016/0191-8141(93)90137-Y

```{r def1}
D1 <- defgrad_from_generalshear(k = 2.5, gamma = 0.9)
print(D1)
```
### Matrix algebra

An *isochoric* deformation tensor creates deformation without volume change. In that case, the determinant of the matrix must be 1. In R, this can be checked using `det()`:

```{r det}
det(D1)
```

The *inverse* of the tensor reverses the deformation. In R, this can be done using `solve()`:

```{r inverse}
solve(D1)
```
The *eigenvectors* of the tensor describe the orientation of the strain ellipse, and the
eigenvalues $\lambda$ describe its shape (i.e. length of the principal axes is
proportional to the amount of stretch).

```{r def_eigen}
eigen(D1)
```

Deformation tensors can be combined using *matrix multiplication*.
The resulting deformation from our general-shear deformation (D1) superimposed by our rotation (D2) is

```{r def2}
D2 <- defgrad_from_axisangle(Line(0, 90), 30)

D12 <- D2 %*% D1 # D1 is applied first
```

> Matrix multiplication is **not commutative**, i.e. $D1 \cdot D2 \neq D2 \cdot D1$

### Transformation using deformation gradient tensor

The deformation can now be applied on some orientation data using linear
transformation:

```{r transform1}
# generate some random lineation
l <- rvmf(100, mu = Line(0, 90), k= 100)

l_transformed <- transform_linear(l, D1)
head(l_transformed)
```

## Velocity gradient tensor

The velocity gradient tensor **L** describes the velocity of particles at any instant during the deformation. 
Velocity gradient tensor from deformation gradient tensor.

-   The `time` argument specifies the time of deformation, i.e. how many
    times the Deformation gradient tensor should be applied.

```{r vel}
L <- velgrad(D1, time = 10)
```

### Decomposition

The velocity gradient tensor **L** can be decomposed into a symmetric matrix **S**
(the rate or stretching tensor) and the skew-symmetric matrix **W** (the spin or 
vorticity tensor).

The stretching matrix (or tensor) and describes
the portion of the deformation that over time produces
strain:

```{r vel_rate}
S <- velgrad_rate(L)
```

The vorticity or spin matrix (tensor) and contains information about the internal rotation during
the deformation: 

```{r vel_spin}
W <- velgrad_spin(L)
```

The eigenvectors of the stretching gradient tensor give the orientations and lengths of the instantaneous stretching axes: 

```{r vel_eigenS}
eigen(S)
```

The eigenvectors of the spin gradient tensor describe the flow apophyses:

```{r vel_eigenW}
eigen(W)
```
### Strain increments

Now we can extract the deformation gradient tensor accumulated after a
given time. Here we extract the deformation gradient tensors for some
time steps using `defgrad()`

-   The `steps` argument specifies how many increments you would like to
    extract (this is also is the "resolution" of the deformation path)
-   The `time`

```{r vel2def}
D1_steps <- defgrad(L, time = 10, steps = 2)
```

Now apply the deformation tensors on some orientation data

```{r transform2}
l_steps <- lapply(D1_steps, function(i){transform_linear(l, i)})
```


### Visualization of deformation over time

And plot the paths showing how the orientations change over time

```{r plot_stereo}
#The axes of our deformation tensor:
axes <- Vec3(c(1, 0, 0), c(0, 1, 0), c(0, 0, 1))

increments <- seq(0, 10, 2)
cols <- assign_col(increments)

par(xpd = NA)
stereo_path(l_steps, type = "l", add = FALSE)
stereo_path(l_steps, type = "p", col = cols, pch = 16, cex = .4)
points(axes, pch = 15); text(axes, labels = c('x', 'y', 'z'), pos = 1)

legend_c(increments, title = "Time")
```

We can also monitor how the orientation tensor changes during progressive deformation:

```{r plot_ortensors}
par(mfrow = c(1, 2))
vollmer_plot(l_steps, type = 'b', col = cols)
hsu_plot(l_steps, type = 'b', col = cols)
```

## References

Fossen, H., & Tikoff, B. (1993). The deformation matrix for simultaneous simple shearing, pure shearing and volume change, and its application to transpression-transtension tectonics. Journal of Structural Geology, 15(3–5), 413–422. https://doi.org/10.1016/0191-8141(93)90137-Y

Sanderson, D. J., & Marchini, W. R. D. (1984). Transpression. Journal of Structural Geology, 6(5), 449–458. https://doi.org/10.1016/0191-8141(84)90058-0