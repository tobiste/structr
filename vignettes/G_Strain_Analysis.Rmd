---
title: "7. Strain and Vorticity Analysis"
author: "Tobias Stephan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{7. Strain Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(20250411)
```

```{r setup, warning=FALSE, message=FALSE}
library(structr)
```

## Strain analysis (fabric analysis)

Import some R-phi data from elliptical strain markers
```{r data}
data(ramsay)
head(ramsay)
```

The mean mean strain ellipse (shape and orientation) of deformed elliptical objects as strain markers can be calculated by using the mean shape matrix and its eigenvalues (Shimamoto and Ikeda, 1976):

```{r mean_strain}
ramsay_mean <- mean_strain_ellipse(r = ramsay[, 1], phi = ramsay[, 2])
print(ramsay_mean)
```
The {structr} algorithm also calculates bootstrapped 95% confidence interval.


To visualize the distribution of the strain values, we  can calculate densities in Rf-Phi space:
```{r density}
out <- hypercontour(r = ramsay[, 1], phi = ramsay[, 2], proj = "rfp")
```


plotted in a **Rf/phi** diagram:
```{r rphi, message=FALSE, warning=FALSE}
#| fig-alt: Rf-phi plot
image(out$x, out$y, out$z,
  asp = ifelse(out$proj != "rfp", 1, NA),
  axes = FALSE,
  ylim = c(1, out$rmax),
  xlab = bquote('Long-axis orientation,'~varphi * " (" * degree * ")"), 
  ylab = bquote('Strain ratio,'~R[f]),
  main = "Rf/phi plot",
  col = viridis::viridis(50)
)

graphics::axis(1, at = seq(-90, 90, 30), gap.axis = 0)
graphics::axis(2, at = pretty(c(1, max(out$y))), gap.axis = 0)

contour(out$x, out$y, out$z, add = TRUE, lwd = .5)
points(out$points, col = "grey", pch = 16, cex = .5)

# add mean strain ellipse
if(require(DescTools)) {
  #95% confidence interval
DescTools::DrawEllipse(x = ramsay_mean$phi, y = ramsay_mean$R, 
            radius.x = diff(ramsay_mean$phi_CI)/2, radius.y = diff(ramsay_mean$R_CI)/2, 
            rot = 0, 
            border = "red", lwd = 2)
} else {
  points(ramsay_mean$phi, ramsay_mean$R, col = 'red', pch = 16)
}


title(sub = bquote('R' == .(round(ramsay_mean$R, 2))~'|'~ phi == .(round(ramsay_mean$phi, 2))*degree))
```

orin an **Equidistant polar plot**:
```{r plot2}
#| fig.alt: >
#|   Elliot plot
out2 <- hypercontour(r = ramsay[, 1], phi = ramsay[, 2], proj = "eqd")

# calculate some colors
levels <- pretty(range(out2$z, na.rm = TRUE), 20)
cols <- viridis::viridis(n = length(levels) - 1)

plot(out2$x, y = out2$y, "n", xlab = NULL, ylab = NULL, asp = 1, axes = FALSE, ann = FALSE)
.filled.contour(out2$x, out2$y, out2$z, levels = levels, col = cols)
# points(out2$points, col = "grey", cex = .5)
lines(out2$frame, lwd = 2)
title(main = "Elliot plot")
```

## Vorticity analysis

The rigid grain net after (Jessup et al. 2007) plots the distribution the 
strain ratio (`R`) of orientation (`phi`) of 
porphyroclast over the theoretical distribution of tailless clasts. The plot estimates 
the critical threshold `Rc` marking the transition between the stable-sink 
position and infinitely rotating porphyroclasts. 
This threshold can be interpreted as the the **mean kinematic vorticity number**.
Here the `Rc` is estimated using the bootstrap method described in Stephan et al. (2025).

```{r vorticity, message=FALSE, warning=FALSE}
#| fig.alt: >
#|   Rigid grain net
theta <- tectonicr::circular_mean(ramsay[, 2]) - ramsay[, 2] # assuming the mean orientation resembles the foliation

RGN_plot(r = ramsay[, 1], theta = theta, col = "#B63679")
title(main = "Rigid Grain Net")
```
